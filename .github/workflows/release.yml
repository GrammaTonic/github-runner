
name: Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.1.0)'
        required: false
        default: ''
      create_draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Mark as prerelease'
        required: false
        type: boolean
        default: false
env:
  REGISTRY: ghcr.io/grammatonic
  IMAGE_NAME: github-runner
jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          ref=${GITHUB_REF#refs/tags/}
          version="$ref"
          is_prerelease="false"
          if [[ "$version" == *-* ]]; then
            is_prerelease="true"
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$is_prerelease" >> "$GITHUB_OUTPUT"
          echo "Version: $version"
          echo "Is prerelease: $is_prerelease"
  build-release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate-release]
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
      chrome-image-digest: ${{ steps.build_chrome.outputs.digest }}
      chrome-image-tags: ${{ steps.meta_chrome.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # Standard runner image metadata
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}
      # Chrome runner image metadata
      - name: Extract Chrome metadata
        id: meta_chrome
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chrome
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Build and push runner image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
      - name: Build and push Chrome runner image
        id: build_chrome
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile.chrome
          push: true
          tags: ${{ steps.meta_chrome.outputs.tags }}
          labels: ${{ steps.meta_chrome.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json


  security-scan-release:
    name: Security Scan Release
    runs-on: ubuntu-latest
    needs: [build-release-artifacts]
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Run Trivy vulnerability scanner (standard)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-release-artifacts.outputs.image-digest }}
          format: "sarif"
          output: "release-security-scan.sarif"
      - name: Run Trivy vulnerability scanner (chrome)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-chrome@${{ needs.build-release-artifacts.outputs.chrome-image-digest }}
          format: "sarif"
          output: "release-chrome-security-scan.sarif"
      - name: Upload security scan results (standard)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "release-security-scan.sarif"
          category: "container-scan"
      - name: Upload security scan results (chrome)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "release-chrome-security-scan.sarif"
          category: "container-scan-chrome"
      - name: Check for critical vulnerabilities (standard)
        run: |
          critical_count=$(grep -c "CRITICAL" release-security-scan.sarif || echo "0")
          if [[ $critical_count -gt 0 ]]; then
            echo "::error::Critical vulnerabilities found in standard release image!"
            echo "::error::Cannot proceed with release. Please fix vulnerabilities first."
            exit 1
          fi
          echo "âœ… No critical vulnerabilities found in standard image"
      - name: Check for critical vulnerabilities (chrome)
        run: |
          critical_count=$(grep -c "CRITICAL" release-chrome-security-scan.sarif || echo "0")
          if [[ $critical_count -gt 0 ]]; then
            echo "::error::Critical vulnerabilities found in Chrome release image!"
            echo "::error::Cannot proceed with release. Please fix vulnerabilities first."
            exit 1
          fi
          echo "âœ… No critical vulnerabilities found in Chrome image"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release-artifacts, security-scan-release]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          version="${{ needs.validate-release.outputs.version }}"

          # Try to extract changelog for this version
          if [[ -f "CHANGELOG.md" ]]; then
            # Extract section for this version
            changelog_content=$(sed -n "/## $version/,/## /p" CHANGELOG.md | sed '$d' | tail -n +2)
          fi

          # If no specific changelog found, generate from commits
          if [[ -z "$changelog_content" ]]; then
            echo "Generating changelog from commits..."
            
            # Get the latest tag before this one
            previous_tag=$(git tag --sort=-version:refname | grep -v "$version" | head -n 1)
            
            if [[ -n "$previous_tag" ]]; then
              range="$previous_tag..HEAD"
            else
              range="HEAD"
            fi
            
            changelog_content="## Changes in $version\n\n"
            changelog_content+=$(git log $range --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save changelog to file
          echo -e "$changelog_content" > release-changelog.md

          echo "Generated changelog:"
          cat release-changelog.md

      - name: Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: Release ${{ needs.validate-release.outputs.version }}
          body_path: release-changelog.md
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is_prerelease }}

      - name: Upload release assets
        run: |
          version="${{ needs.validate-release.outputs.version }}"

          # Create release assets directory
          mkdir -p release-assets

          # Copy important files to release assets
          cp README.md release-assets/
          cp -r docker/ release-assets/
          cp -r scripts/ release-assets/
          cp -r config/ release-assets/

          # Create installation script
          cat > release-assets/install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing GitHub Runner ${{ needs.validate-release.outputs.version }}"

          # Download and setup the runner
          echo "This script would download and configure the GitHub self-hosted runner"
          echo "Version: ${{ needs.validate-release.outputs.version }}"
          echo "Image: ${{ needs.build-release-artifacts.outputs.image-tags }}"

          echo "Installation completed!"
          EOF

          chmod +x release-assets/install.sh

          # Create archive
          tar -czf github-runner-$version.tar.gz -C release-assets .

          echo "Release assets created:"
          ls -la github-runner-*.tar.gz

      - name: Upload installation archive
        uses: actions/upload-artifact@v4
        with:
          name: github-runner-${{ needs.validate-release.outputs.version }}
          path: github-runner-*.tar.gz
          retention-days: 365

  deploy-release:
    name: Deploy Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release-artifacts, create-release]
    permissions:
      contents: read
      packages: read
    if: ${{ needs.validate-release.outputs.is_prerelease == 'false' }}
    steps:
      - name: Deploy release to production
        run: |
          version="${{ needs.validate-release.outputs.version }}"
          image_digest="${{ needs.build-release-artifacts.outputs.image-digest }}"

          echo "Deploying release $version to production"
          echo "Image digest: $image_digest"

          # In a real scenario, this would deploy the release
          # For example: kubectl set image, docker service update, etc.

          echo "âœ… Release $version deployed successfully"

      - name: Post-deployment verification
        run: |
          echo "Running post-deployment verification..."

          # Add comprehensive health checks for the release
          sleep 30

          echo "âœ… Release verification completed successfully"

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [validate-release, create-release, deploy-release]
    if: always()
    steps:
      - name: Notify release status
        run: |
          version="${{ needs.validate-release.outputs.version }}"

          if [[ "${{ needs.deploy-release.result }}" == "success" ]]; then
            echo "ğŸ‰ Release $version completed successfully!"
            echo "âœ… Built, tested, and deployed to production"
          elif [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "ğŸ“¦ Release $version created successfully!"
            echo "â„¹ï¸  Draft release created - ready for manual review"
          else
            echo "âŒ Release $version failed"
            echo "Please check the workflow logs for details"
          fi

          # In a real scenario, you might send notifications to Slack, Teams, etc.
          echo "Release notification sent"
