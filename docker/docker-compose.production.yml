services:
  github-runner:
    image: ghcr.io/grammatonic/github-runner:latest
    container_name: github-runner-main
    restart: unless-stopped
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - RUNNER_NAME=${RUNNER_NAME:-docker-runner}
      - RUNNER_LABELS=${RUNNER_LABELS:-docker,self-hosted,linux,x64}
      - RUNNER_GROUP=${RUNNER_GROUP:-default}
      - RUNNER_WORKDIR=${RUNNER_WORKDIR:-/home/runner/_work}
      - RUNNER_EPHEMERAL=${RUNNER_EPHEMERAL:-false}
      - RUNNER_REPLACE_EXISTING=${RUNNER_REPLACE_EXISTING:-true}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - runner-cache:/home/runner/_work
      - runner-config:/home/runner/.config
      - runner-cache-npm:/home/runner/.npm
      - runner-cache-pip:/home/runner/.cache/pip
    # Drop all capabilities except those needed for Docker socket
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    networks:
      - runner-network
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Runner.Listener"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  runner-cache:
    driver: local
  runner-config:
    driver: local
  runner-cache-npm:
    driver: local
  runner-cache-pip:
    driver: local

networks:
  runner-network:
    driver: bridge
    name: github-runners
